#!/bin/bash

LTEPI_GITHUB_ID=Robotma-com/ltepi
VENDOR_HOME=/opt/inn-farm
PROJECT_HOME=${VENDOR_HOME}/ltepi
BIN_PATH=${PROJECT_HOME}/bin

function err {
  echo -e "\033[91m[ERROR] $1\033[0m"
}

function info {
  echo -e "\033[92m[INFO] $1\033[0m"
}

function alert {
  echo -e "\033[93m[ALERT] $1\033[0m"
}

function assert_root {
  if [[ $EUID -ne 0 ]]; then
     echo "This script must be run as root" 
     exit 1
  fi
}

function assert_vars {
  if [ -z "${VERSION}" ]; then
    echo "VERSION is missing" 
    exit 1
  fi
  if [ -z "${LTEPI_VERSION}" ]; then
    echo "LTEPI_VERSION is missing" 
    exit 1
  fi
}

function install_cli {
  info "Installing command lines to /opt/inn-farm/ltepi/bin..."
  for f in $(ls ./bin); do
    install -o root -g root -D -m 755 bin/${f} ${BIN_PATH}/${f}
  done
  install -o root -g root -D -m 755 uninstall.sh ${BIN_PATH}/uninstall.sh
  
  for p in $(ls ./bin/ltepi_*); do
    f=$(basename ${p})
    ln -sn ${BIN_PATH}/${f} /usr/bin/${f}
  done

  info "Installing config files to /opt/inn-farm/ltepi/bin..."
  echo "${VERSION}" > ./bin/version.txt
  install -o root -g root -D -m 644 bin/version.txt ${BIN_PATH}/version.txt
  install -o root -g root -D -m 644 apn.json ${BIN_PATH}/apn.json
}

function install_ltepi {
  info "Installing LTEPi Python Library..."
  if [ ! -d "ltepi-${LTEPI_VERSION}" ]; then
    curl -L https://github.com/${LTEPI_GITHUB_ID}/archive/${LTEPI_VERSION}.tar.gz | tar zx
  fi
  cd ltepi-${LTEPI_VERSION}
  ./install.sh ${BIN_PATH}
  cd ../
  rm -rf ltepi-${LTEPI_VERSION}
}

assert_root
assert_vars
install_cli
install_ltepi

alert "** LTEPi software has been successfully installed **"
alert "** Please run 'sudo reboot'! **"
